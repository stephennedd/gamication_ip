<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <!-- background -->
    <div id="container">
    </div>

    <div class="dropdown">
        <button class="dropbtn">Select Leaderboard</button>
        <div id="dropdown-content" class="dropdown-content">
            <!-- Leaderboard options will be dynamically added here -->
        </div>
    </div>

    <!-- title -->
    <div class="title">
        <h1>Leaderboard</h1>
    </div>

    <!-- buttons -->
    <div class="buttons">
        <button class="start_btn">Start Game</button>
        <button class="quit_btn">Quit</button>
    </div>
    

    <!-- leaderboard -->
    <div class="leaderboard">
        <div class="leaderboard-container">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Position</th>
                        <th>Player Name</th>
                        <th>Score</th>
                        <th>Badges</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Leaderboard data will be dynamically added here -->
                </tbody>
            </table>
        </div>
    </div>
    
    
    <script>
        let currentLeaderboard = 'main'; // Default leaderboard name
        let token = 'eyJhbGciOiJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNobWFjLXNoYTUxMiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiQWRtaW4iLCJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dzLzIwMDgvMDYvaWRlbnRpdHkvY2xhaW1zL3JvbGUiOiJBZG1pbiIsImV4cCI6MTY4NjQyMjYzMH0.YnA8Zetv7sFCKpD3ODqmustYM-vEQABvmQk0Cd0gwZPxQaZf3FP_AJZx88yojrF76UGsH6oL9ZNPjGYoajIxKQ'; // replace with your actual token
        // Sample leaderboard data (you can replace this with your API or data source)
        let leaderboardData = [
            { playerName: "John", score: 500, badges: ["badge1.png", "badge2.png"] },
            { playerName: "Emma", score: 400 , badges: ["badge3.png"]},
            { playerName: "Michael", score: 300, badges: []  },
            { playerName: "Sophia", score: 200 , badges: ["badge4.png"]},
            { playerName: "William", score: 100, badges: ["badge5.png", "badge6.png"] },
        ];
        async function getLeaderboards() {
    try {
        let response = await fetch('https://localhost:7186/api/Leaderboards', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        let data = await response.json();
        console.log('Received leaderboard data:', data); // Print the raw data

        let leaderboardNames = data.$values.map(lb => lb.name);
        console.log('Extracted leaderboard names:', leaderboardNames); // Print the leaderboard names

        const dropdownContent = document.getElementById('dropdown-content');
        dropdownContent.innerHTML = ''; // Clear existing leaderboard options

        leaderboardNames.forEach((name) => {
            const a = document.createElement('a');
            a.href = '#';
            a.className = 'dropdown-link';
            a.innerText = name;
            a.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent the default click action
                currentLeaderboard = name; // Set the current leaderboard
                getDataFromAPI(); // Update the leaderboard
            });
            dropdownContent.appendChild(a);
        });

    } catch (error) {
        console.log('Fetch Error: ', error);
    }
}

        // Function to populate the leaderboard table
        function populateLeaderboard() {
            // Sort the leaderboard data based on scores in descending order
            leaderboardData.sort((a, b) => b.score - a.score);

            const leaderboardBody = document.getElementById('leaderboard-body');
            leaderboardBody.innerHTML = ''; // Clear existing leaderboard data

            leaderboardData.forEach((entry, index) => {
                const position = index + 1;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${position}</td>
                    <td>${entry.playerName}</td>
                    <td>${entry.score}</td>
                    <td>${entry.badges.map(badge => `<img src="./assets/images/${badge}" height="25px" alt="Badge">`).join('')}</td>
                `;
                leaderboardBody.appendChild(row);
            });
        }
        async function getDataFromAPI() {
    

    try {
        let response = await fetch('https://localhost:7186/api/Leaderboards/' + currentLeaderboard, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        let data = await response.json();
        console.log('Received data:', data); // Print the raw data

        // Extract highScores array
        let highScores = data.highScores.$values;

        console.log('Extracted highScores:', highScores); // Print the extracted highScores

        // Map the highScores array to an array of simplified objects
        leaderboardData = highScores.reduce((result, scoreEntry) => {
            console.log('Processing scoreEntry:', scoreEntry); // Print each scoreEntry being processed

            if (scoreEntry.user) {
                result.push({
                    playerName: scoreEntry.user.id,
                    score: scoreEntry.score,
                    badges: [] // Add badge logic here if available
                });
            }

            return result;
        }, []);

        // Call populateLeaderboard() to update the leaderboard
        populateLeaderboard();
    } catch (error) {
        console.log('Fetch Error: ', error);
    }
}

        // Call the function to populate the leaderboard on page load
        getDataFromAPI();
        // Call the function to populate the leaderboard names on page load
getLeaderboards();
        
    </script>

    <script src="./js/starfield.js"></script>
    <script>
        //  Get the container and turn it into a starfield.
        var container = document.getElementById('container');
        var starfield = new Starfield();
        starfield.initialise(container);
        starfield.start();
    </script>
</body>
</html>